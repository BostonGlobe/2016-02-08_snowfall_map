<!doctype html>
<html lang='en' style='height: auto;'>
    <head>
        <title>The Boston Globe - graphic</title>
        <meta name='viewport' content='width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no'>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
        <meta http-equiv='Cache-Control' content='no-cache, no-store, must-revalidate' />
        <meta http-equiv='Pragma' content='no-cache' />
        <meta http-equiv='Expires' content='0' />

        <script type='text/javascript'>
            // https://github.com/BostonGlobe/slush-globeapp/blob/master/templates/src/html/partials/base/base-critical.hbs
            !function(e){var t=function(t,n){"use strict";var o=e.document.getElementsByTagName("script")[0],r=e.document.createElement("script");return r.src=t,r.async=!0,o.parentNode.insertBefore(r,o),n&&"function"==typeof n&&(r.onload=n),r};"undefined"!=typeof module?module.exports=t:e.loadJS=t}("undefined"!=typeof global?global:this),function(e){"use strict";var t=function(t,n,o){var r,l=e.document,i=l.createElement("link");if(n)r=n;else{var a=(l.body||l.getElementsByTagName("head")[0]).childNodes;r=a[a.length-1]}var d=l.styleSheets;i.rel="stylesheet",i.href=t,i.media="only x",r.parentNode.insertBefore(i,n?r:r.nextSibling);var f=function(e){for(var t=i.href,n=d.length;n--;)if(d[n].href===t)return e();setTimeout(function(){f(e)})};return i.onloadcssdefined=f,f(function(){i.media=o||"all"}),i};"undefined"!=typeof module?module.exports=t:e.loadCSS=t}("undefined"!=typeof global?global:this);

            !function(e){var t="https://apps.bostonglobe.com/common/font/",n=e.document;if("querySelector"in n){var o=function(e){if(!("FontFace"in e))return!1;var t=new e.FontFace("t",'url( "data:application/font-woff2," ) format( "woff2" )');return t.load().catch(function(){}),"loading"===t.status}(e),r=navigator.userAgent,i=t+"woff.css";o?i=t+"woff2.css":r.indexOf("Android")>-1&&r.indexOf("like Gecko")>-1&&-1===r.indexOf("Chrome")&&(i=t+"ttf.css"),loadCSS(i)}}(this);
        </script>

        <noscript><link href='https://apps.bostonglobe.com/common/font/nojs-fonts.css' rel='stylesheet'></noscript>

        <!-- see http://bostonglobe.github.io/news-apps-style-guide for how to use base.css -->
        <link rel='stylesheet' href='https://apps.bostonglobe.com/common/css/base/base-1.2.0.css'>

        <link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet' />

        <style>/* =========================== */
/* Globe font stack examples
/* =========================== */
/* Serif headline */
/* font-family: 'Miller', Helvetica, Times New Roman, Times, serif;* /

/* Sans-serif headline */
/* font-family: 'Benton', Helvetica, Arial, sans-serif; */
/* Serif body */
/* font-family: 'Georgia', Times New Roman, Times, serif; */
/* Sans-serif body */
/* font-family: 'Helvetica', Arial, sans-serif; */
/* =========================== */
/* Graphic styles
/* =========================== */
.leaflet-container .leaflet-control-attribution {
  display: none;
}
#map {
  width: 100%;
  min-height: 320px;
  display: block;
  border: 1px solid #ccc;
}

.map-and-legend {
	position: relative;
}

.map-and-legend .legend {
	position: absolute;
	top: 0.75em;
	right: 0.75em;
	z-index: 10;
	background: white;
	min-width: 17em;
	border: 1px solid #999;
	border-radius: 3px;
	padding: 0.25em 0.75em;
}
@media (min-width: 30em) {
	.map-and-legend .legend {
		min-width: 25em;
	}
}

.leaflet-overlay-pane {
	z-index: 1;
}

.leaflet-marker-icon.snowfall {
  text-align: center;
  cursor: inherit;
  outline: none;
}
.leaflet-marker-icon.snowfall span.wrapper {
  font-family: 'Benton', Helvetica, Arial, sans-serif;
  font-weight: bold;
  color: #333;
  text-shadow: #fff 0 0 3px;
  position: relative;
  top: -0.6em;
  font-size: 1.2em;
}
.leaflet-marker-icon.snowfall span.wrapper._zoom7 {
  font-size: 1.3em;
  top: -0.65em;
}
.leaflet-marker-icon.snowfall span.wrapper._zoom8 {
  font-size: 1.4em;
  top: -0.7em;
}
.leaflet-marker-icon.snowfall span.wrapper._zoom9 {
  font-size: 1.5em;
  top: -0.75em;
}
.leaflet-marker-icon.snowfall span.wrapper._zoom10 {
  font-size: 1.6em;
  top: -0.8em;
}
.legend {
  font-family: 'Benton', Helvetica, Arial, sans-serif;
  font-size: 0.9em;
  max-width: 25em;
  /* display: none; */
}
.legend p span {
  font-weight: bold;
}
.legend ul {
  width: 100%;
  overflow: hidden;
  list-style-type: none;
}
.legend ul li {
  float: left;
  width: 25%;
  font-size: 0.8em;
}
.legend ul li.odd {
  display: none;
}
@media (min-width: 30em) {
  .legend ul li {
    width: 9%;
  }
  .legend ul li.odd {
    display: block;
  }
}
.legend ul.colors li {
  height: 0.55em;
}
.legend ul.numbers li {
  text-align: center;
  position: relative;
}
.legend ul.numbers li:nth-child(1) {
  text-align: left;
}
.legend ul.numbers li:nth-child(1) span {
  left: 0;
}
.legend ul.numbers li span {
  position: relative;
  left: -50%;
}
.legend ul.numbers .units {
  display: none;
}
.updated {
  font-family: 'Benton', Helvetica, Arial, sans-serif;
  text-align: center;
  font-size: 0.8em;
  color: #888;
  margin-bottom: 1em;
}
</style>

        <link rel='shortcut icon' href='https://www.bostonglobe.com/rw/SysConfig/WebPortal/BostonGlobe/Framework/images/favicon.ico' />
    </head>
    <body style='height: auto;'>

        <!-- *** DO NOT DELETE *** -->
        <div id='globe-graphic-container' style='height: 100%; overflow: hidden;'>

            <!--
            ==========================
            (begin) graphic HTML here
            ==========================
            -->

            <p class='updated'><p>

						<div class='map-and-legend'>

							<div class='legend'>
									<p><span>Recent snowfall</span><span class='units'> (inches)</span></p>
									<ul class='colors'>
											<li class='' style='background: #dde6f1'></li>
											<li class='odd' style='background: #bacce3'></li>
											<li class='odd' style='background: #b5c6df'></li>
											<li class='' style='background: #adb7d8'></li>
											<li class='odd' style='background: #a5aad0'></li>
											<li class='odd' style='background: #9f9cc8'></li>
											<li class='' style='background: #998cbf'></li>
											<li class='odd' style='background: #8a69a8'></li>
											<li class='odd' style='background: #7a468c'></li>
											<li class='' style='background: #65246d'></li>
											<li class='odd' style='background: #4d004b'></li>
									</ul>
									<ul class='numbers'>
											<li class=''><span>0</span></li>
											<li class='odd'><span>1</span></li>
											<li class='odd'><span>2</span></li>
											<li class=''><span>4</span></li>
											<li class='odd'><span>6</span></li>
											<li class='odd'><span>8</span></li>
											<li class=''><span>10</span></li>
											<li class='odd'><span>15</span></li>
											<li class='odd'><span>20</span></li>
											<li class=''><span>25</span></li>
											<li class='odd'><span>30+</span></li>
									</ul>
							</div>

							<div id='map'>
							</div>

						</div>

            <div class='source-and-credit'>
                <p class='source'><span>SOURCE: National Weather Service</span></p>
                <!-- <p class='credit'><span>Reporter / Globe Staff</span></p> -->
            </div>

            <!--
            ==========================
            (end) graphic HTML here
            ==========================
            -->

        </div>

        <!-- (begin) js libraries -->
        <script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
        <script src='https://apps.bostonglobe.com/common/js/lodash/lodash-3.10.0.min.js'></script>
        <!-- (end) -->





        <!-- *** DO NOT GO BELOW HERE *** -->

        <script type="text/javascript">'use strict';

(function () {
	// global variables
	var map = undefined;
	var data = undefined;
	var markersLayer = undefined;

	var scale = [
		{ 'amount': 0.1, 'hex': '#DDE6F1' },
		{ 'amount': 1, 'hex': '#bacce3' },
		{ 'amount': 2, 'hex': '#b5c6df' },
		{ 'amount': 4, 'hex': '#adb7d8' },
		{ 'amount': 6, 'hex': '#a5aad0' },
		{ 'amount': 8, 'hex': '#9f9cc8' },
		{ 'amount': 10, 'hex': '#998cbf' },
		{ 'amount': 15, 'hex': '#8a69a8' },
		{ 'amount': 20, 'hex': '#7a468c' },
		{ 'amount': 25, 'hex': '#65246d' },
		{ 'amount': 30, 'hex': '#4d004b' }
	];

	// called once on page load
	var init = function init() {
		setupMap();
		setHeight();
		loadData();
	};

	// called automatically on page resize
	window.onPymParentResize = function (width) {};

	var loadData = function loadData() {
		var el = document.createElement('script');
		el.setAttribute('src', 'https://www.bostonglobe.com/partners/snowfallscraper/snowfall_scraper.json');
		document.body.appendChild(el);
	};

	var setHeight = function setHeight() {
		if (window.pymChild) {
			window.pymChild.sendMessage('height-request', true);
			window.pymChild.onMessage('height-send', function (msg) {
				var initialHeight = +msg;
				document.getElementById('map').style.height = Math.floor(initialHeight * 0.67) + 'px';
			});
		} else {
			setTimeout(setHeight, 30);
		}
	};

	var setupMap = function setupMap() {

		var defaultZoom = window.innerWidth < 640 ? 7 : 8;

		L.mapbox.accessToken = 'pk.eyJ1IjoiZ2FicmllbC1mbG9yaXQiLCJhIjoiVldqX21RVSJ9.Udl7GDHMsMh8EcMpxIr2gA';
		map = L.mapbox.map('map', 'gabriel-florit.36cf07a4', {
			attributionControl: false,
			scrollWheelZoom: false,
			minZoom: 7,
			maxZoom: 10,
			maxBounds: [[24, -93], [51, -60]]
		});

		map.setView([42.25, -71.82], defaultZoom);

		// we came up with these after much tweaking
		var customBounds = [
			[21.1, -83],
			[49.65, -66]
		];

		// Add the snowfall image to the map.
		var imageLayer = L.imageOverlay('http://localhost:3003/output.png', customBounds).addTo(map);

		map.on('zoomend', function (e) {
			addMarkersToMap(map.getZoom());
		});
	};

	var getIconDimensions = function getIconDimensions(zoom) {
		return {
			6: {
				width: 34,
				height: 21
			},
			7: {
				width: 34,
				height: 21
			},
			8: {
				width: 45,
				height: 27
			},
			9: {
				width: 45,
				height: 27
			},
			10: {
				width: 60,
				height: 36
			}
		}[zoom];
	};

	var intersectRect = function intersectRect(r1, r2) {
		return !(r2.left > r1.right || r2.right < r1.left || r2.top > r1.bottom || r2.bottom < r1.top);
	};

	var addMarkersToMap = function addMarkersToMap(zoom) {

		var max = getMax(data);

		var iconDimensions = getIconDimensions(zoom);

		var ICON_WIDTH = iconDimensions.width;
		var ICON_HEIGHT = iconDimensions.height;

		var markers = [];

		// for each point,
		// find the absolute pixel coordinates for the given zoom level
		// assuming we're center aligning the point,
		// find the point's bounding box in pixel coordinates
		var byLat = data.sort(function (a, b) {
			return b['Latitude'] - a['Latitude'];
		});
		var byLng = data.sort(function (a, b) {
			return a['Longitude'] - b['Longitude'];
		});
		var byAmount = data.sort(function (a, b) {
			return b['Amount'] - a['Amount'];
		});

		byAmount.map(function (point, index) {
			var pointCoords = map.project([point['Latitude'], point['Longitude']]);

			var pointBBox = {
				left: pointCoords.x - ICON_WIDTH / 2,
				right: pointCoords.x + ICON_WIDTH / 2,
				bottom: pointCoords.y + ICON_HEIGHT / 2,
				top: pointCoords.y - ICON_HEIGHT / 2
			};

			// make sure this bbox doesn't overlap with any existing markers
			var overlaps = _.some(markers, function (marker) {

				var markerCoords = map.project(marker._latlng);

				var markerBBox = {
					left: markerCoords.x - ICON_WIDTH / 2,
					right: markerCoords.x + ICON_WIDTH / 2,
					bottom: markerCoords.y + ICON_HEIGHT / 2,
					top: markerCoords.y - ICON_HEIGHT / 2
				};

				return intersectRect(pointBBox, markerBBox);
			});

			// overlaps = false;
			// if it doesn't overlap, add to markers layer
			if (!overlaps) {

				var hex = getHexFromAmount(point['Amount']);

				if (hex) {
					var icon = L.divIcon({
						html: '<span class="wrapper _zoom' + zoom + '"><span class="label">' + point['Amount'] + '”</span></span>',
						className: 'snowfall'
					});

					var marker = L.marker([point['Latitude'], point['Longitude']], {
						icon: icon,
						clickable: false
					});
					markers.push(marker);
				}
			}
		});

		if (markersLayer) {
			map.removeLayer(markersLayer);
		}

		markersLayer = L.layerGroup(markers);

		markersLayer.addTo(map);
	};

	var getMax = function getMax(arr) {
		return arr.reduce(function (previous, current) {
			return current['Amount'] > previous ? current['Amount'] : previous;
		}, 0);
	};

	var getHexFromAmount = function getHexFromAmount(amount) {
		var filtered = scale.filter(function (el) {
			return amount >= el.amount;
		});
		if (filtered.length) {
			return filtered[filtered.length - 1].hex;
		}
		return null;
	};

	window.snowfall_scraper = function (response) {
		var dataset = 'climate';
		var updated = new Date(response.updated);

		var timeString = updated.toLocaleTimeString();
		var timeSplit = timeString.split(':');
		var ampm = timeSplit[2].split(' ');

		var updatedString = updated.toLocaleDateString() + ' ' + timeSplit[0] + ':' + timeSplit[1] + ' ' + ampm[1];
		document.querySelector('.updated').textContent = 'Last updated ' + updatedString;

		data = response[dataset].map(function (el) {
			el['Latitude'] = parseFloat(el['Latitude']);
			el['Longitude'] = parseFloat(el['Longitude']);
			el['Amount'] = parseFloat(el['Amount']);
			return el;
		});

		addMarkersToMap(map.getZoom());
	};

	// run code
	init();
})();
</script>

         <!-- (begin) globe iframe embed -->
        <script type='text/javascript'>
            // https://github.com/BostonGlobe/pym.js
            !function(e){"function"==typeof define&&define.amd?define(e):"undefined"!=typeof module&&module.exports?module.exports=e():window.pym=e.call(this)}(function(){var e="xPYMx",t={},i=function(e){var t=new RegExp("[\\?&]"+e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")+"=([^&#]*)"),i=t.exec(location.search);return null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))},s=function(e,t){return"*"===t.xdomain||e.origin.match(new RegExp(t.xdomain+"$"))?!0:void 0},n=function(t,i,s){var n=["pym",t,i,s];return n.join(e)},a=function(t){var i=["pym",t,"(\\S+)","(.+)"];return new RegExp("^"+i.join(e)+"$")},r=function(){for(var e=document.querySelectorAll("[data-pym-src]:not([data-pym-auto-initialized])"),i=e.length,s=0;i>s;++s){var n=e[s];n.setAttribute("data-pym-auto-initialized",""),""===n.id&&(n.id="pym-"+s);var a=n.getAttribute("data-pym-src"),r=n.getAttribute("data-pym-xdomain"),h={};r&&(h.xdomain=r),new t.Parent(n.id,a,h)}};return t.Parent=function(e,t,i){this.id=e,this.url=t,this.el=document.getElementById(e),this.iframe=null,this.settings={xdomain:"*"},this.messageRegex=a(this.id),this.messageHandlers={},i=i||{},this._constructIframe=function(){var e=this.el.offsetWidth.toString();this.iframe=document.createElement("iframe");var t="",i=this.url.indexOf("#");i>-1&&(t=this.url.substring(i,this.url.length),this.url=this.url.substring(0,i)),this.url.indexOf("?")<0?this.url+="?":this.url+="&",this.iframe.src=this.url+"initialWidth="+e+"&childId="+this.id+"&parentUrl="+encodeURIComponent(window.location.href)+t,this.iframe.setAttribute("width","100%"),this.iframe.setAttribute("scrolling","no"),this.iframe.setAttribute("marginheight","0"),this.iframe.setAttribute("frameborder","0"),this.el.appendChild(this.iframe),window.addEventListener("resize",this._onResize)},this._onResize=function(){this.sendWidth()}.bind(this),this._fire=function(e,t){if(e in this.messageHandlers)for(var i=0;i<this.messageHandlers[e].length;i++)this.messageHandlers[e][i].call(this,t)},this.remove=function(){window.removeEventListener("message",this._processMessage),window.removeEventListener("resize",this._onResize),this.el.removeChild(this.iframe)},this._processMessage=function(e){if(s(e,this.settings)&&"string"==typeof e.data){var t=e.data.match(this.messageRegex);if(!t||3!==t.length)return!1;var i=t[1],n=t[2];this._fire(i,n)}}.bind(this),this._onHeightMessage=function(e){var t=parseInt(e);this.iframe.setAttribute("height",t+"px")},this._onNavigateToMessage=function(e){document.location.href=e},this.onMessage=function(e,t){e in this.messageHandlers||(this.messageHandlers[e]=[]),this.messageHandlers[e].push(t)},this.sendMessage=function(e,t){this.el.getElementsByTagName("iframe")[0].contentWindow.postMessage(n(this.id,e,t),"*")},this.sendWidth=function(){var e=this.el.offsetWidth.toString();this.sendMessage("width",e)};for(var r in i)this.settings[r]=i[r];return this.onMessage("height",this._onHeightMessage),this.onMessage("navigateTo",this._onNavigateToMessage),window.addEventListener("message",this._processMessage,!1),this._constructIframe(),this},t.Child=function(t){this.parentWidth=null,this.id=null,this.parentUrl=null,this.settings={renderCallback:null,xdomain:"*",polling:0},this.messageRegex=null,this.messageHandlers={},t=t||{},this.onMessage=function(e,t){e in this.messageHandlers||(this.messageHandlers[e]=[]),this.messageHandlers[e].push(t)},this._fire=function(e,t){if(e in this.messageHandlers)for(var i=0;i<this.messageHandlers[e].length;i++)this.messageHandlers[e][i].call(this,t)},this._processMessage=function(e){if(s(e,this.settings)&&"string"==typeof e.data){var t=e.data.match(this.messageRegex);if(t&&3===t.length){var i=t[1],n=t[2];this._fire(i,n)}}}.bind(this),this._onWidthMessage=function(e){var t=parseInt(e);t!==this.parentWidth&&(this.parentWidth=t,this.settings.renderCallback&&this.settings.renderCallback(t),this.sendHeight())},this._poll=function(){var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return setTimeout(e,1e3/60)},t={previous:0,current:0},i=document.getElementsByTagName("body")[0],s=function(){t.current=i.offsetHeight,t.current!==t.previous&&(t.previous=t.current,this.sendHeight()),e(s)}.bind(this);s()},this.sendMessage=function(e,t){window.parent.postMessage(n(this.id,e,t),"*")},this.sendHeight=function(){var e=document.getElementsByTagName("body")[0].offsetHeight.toString();this.sendMessage("height",e)}.bind(this),this.scrollParentTo=function(e){this.sendMessage("navigateTo","#"+e)},this.navigateParentTo=function(e){this.sendMessage("navigateTo",e)},this.id=i("childId")||t.id,this.messageRegex=new RegExp("^pym"+e+this.id+e+"(\\S+)"+e+"(.+)$");var a=parseInt(i("initialWidth"));this.parentUrl=i("parentUrl"),this.onMessage("width",this._onWidthMessage);for(var r in t)this.settings[r]=t[r];return window.addEventListener("message",this._processMessage,!1),this.settings.renderCallback&&this.settings.renderCallback(a),this.sendHeight(),this.settings.polling&&this._poll(),this},r(),t});

            window.pymChild = pym.Child({ renderCallback: window.onPymParentResize, polling: true });
            // version
            if (window.console && console.log) console.log('-- globe iframe graphic v1.3.0 --');
        </script>
        <!-- (end) globe iframe embed -->
    </body>
</html>
